local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local warnCommand = '/warns'
local spamWarnCommand = '/spamwarns'
local unspamCommand = '/unspam'
local givePowerCommand = '/givepower'
local cmdsCommand = '/cmds' -- New command to show available commands
local playersWithPower = {}
local activeSpamWarns = {}  -- Table to track active spam warns
local spamWarningOwners = {} -- Track who initiated the spam warning
local notificationLimit = 100 -- Set the maximum number of notifications per cycle
local notificationInterval = 0.1 -- Time interval between cycles (in seconds)
local oldChat = false

-- Check if the old chat system is being used
if ReplicatedStorage:FindFirstChild('DefaultChatSystemChatEvents') then
    oldChat = true
end

-- Function to send a message
local function Chat(msg, player)
    if oldChat then
        ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(msg, "All")
    else
        game:GetService("TextChatService").TextChannels.RBXGeneral:SendAsync(msg)
    end
end

local function spamWarnAll(player)
    while activeSpamWarns[player.Name] do
        local sentNotifications = 0 
        
        for _, victimPlayer in ipairs(Players:GetPlayers()) do
            if not activeSpamWarns[player.Name] then
                return
            end
            
            if sentNotifications < notificationLimit then
                ReplicatedStorage.Notification.PlayerSelectedEvent:FireServer(victimPlayer.Name)
                sentNotifications = sentNotifications + 1
            else
                break
            end
        end

        wait(notificationInterval)
    end
end

local function spamWarnPlayer(player, targetPlayer)
    while activeSpamWarns[player.Name] and activeSpamWarns[targetPlayer.Name] do
        local sentNotifications = 0
        
        if sentNotifications < notificationLimit then
            ReplicatedStorage.Notification.PlayerSelectedEvent:FireServer(targetPlayer.Name)
            sentNotifications = sentNotifications + 1
        end

        wait(notificationInterval)
    end
end

local function onPlayerChatted(player, message)
    local args = message:split(" ")
    local command = string.lower(args[1])

    if command == string.lower(givePowerCommand) and args[2] then
        local targetPlayer = Players:FindFirstChild(args[2])
        if not targetPlayer then
            for _, p in ipairs(Players:GetPlayers()) do
                if string.lower(p.DisplayName) == string.lower(args[2]) then
                    targetPlayer = p
                    break
                end
            end
        end
        
        if targetPlayer then
            if not playersWithPower[targetPlayer.Name] then
                playersWithPower[targetPlayer.Name] = true
                Chat("ðŸŽ–ï¸âœ¨ " .. targetPlayer.DisplayName .. ", you have been chosen by " .. player.DisplayName .. "! ðŸŽ–ï¸âœ¨", targetPlayer)
                wait(0.5)  -- Small delay to ensure the order
                Chat("âš¡ You now possess **warning power**! âš¡", targetPlayer)
                wait(0.5)  -- Another delay
                Chat("ðŸ›¡ï¸ **Here are your available commands:** ðŸ›¡ï¸", targetPlayer)
                wait(0.5)  -- Delay before listing commands
                Chat("ðŸ“œ  /warns [player]\nðŸ“œ  /warns all\nðŸ“œ  /spamwarns [player]\nðŸ“œ  /spamwarns all\nðŸ“œ  /unspam\nðŸ“œ  /cmds", targetPlayer)
            else
                Chat("âš ï¸ " .. targetPlayer.DisplayName .. " already has warning power. âš ï¸", player)
            end
            return
        else
            Chat("âŒ Player not found: " .. args[2] .. " âŒ", player)
            return
        end
    elseif command == string.lower(warnCommand) then
        if playersWithPower[player.Name] then
            if args[2] and args[2] == "all" then
                -- Warn all players
                local sentNotifications = 0
                for _, victimPlayer in ipairs(Players:GetPlayers()) do
                    if sentNotifications < notificationLimit then
                        ReplicatedStorage.Notification.PlayerSelectedEvent:FireServer(victimPlayer.Name)
                        sentNotifications = sentNotifications + 1
                    else
                        break
                    end
                end
                Chat("âš ï¸ You have warned everyone in the server! âš ï¸", player)
            elseif args[2] then
                -- Warn a specific player
                local victimPlayer = Players:FindFirstChild(args[2])
                if not victimPlayer then
                    for _, p in ipairs(Players:GetPlayers()) do
                        if string.lower(p.DisplayName) == string.lower(args[2]) then
                            victimPlayer = p
                            break
                        end
                    end
                end
                
                if victimPlayer then
                    ReplicatedStorage.Notification.PlayerSelectedEvent:FireServer(victimPlayer.Name)
                    Chat("âš ï¸ You have warned " .. victimPlayer.DisplayName .. ". âš ï¸", player)
                else
                    Chat("âŒ Player not found: " .. args[2] .. " âŒ", player)
                end
            else
                Chat("âš ï¸ Specify a player to warn or use '/warns all' to warn everyone. âš ï¸", player)
            end
        else
            Chat("âŒ " .. player.DisplayName .. ", you do not have permission to warn players. âŒ", player)
        end
    elseif command == string.lower(spamWarnCommand) then
        if args[2] then
            -- Spam warn a specific player
            local targetPlayer = Players:FindFirstChild(args[2])
            if not targetPlayer then
                for _, p in ipairs(Players:GetPlayers()) do
                    if string.lower(p.DisplayName) == string.lower(args[2]) then
                        targetPlayer = p
                        break
                    end
                end
            end

            if targetPlayer then
                if playersWithPower[player.Name] then
                    if not activeSpamWarns[targetPlayer.Name] then
                        activeSpamWarns[targetPlayer.Name] = true
                        spamWarningOwners[targetPlayer.Name] = player.Name -- Track who initiated the spam warning
                        Chat("âš¡ You are now spam-warning " .. targetPlayer.DisplayName .. "! âš¡", player)
                        spamWarnPlayer(player, targetPlayer) -- Start the spam warn loop for the specific player
                    else
                        Chat("âš ï¸ " .. targetPlayer.DisplayName .. " is already being spam-warned! âš ï¸", player)
                    end
                else
                    Chat("âŒ " .. player.DisplayName .. ", you do not have permission to spam warn players. âŒ", player)
                end
            else
                Chat("âŒ Player not found: " .. args[2] .. " âŒ", player)
            end
        elseif args[2] == "all" then
            if playersWithPower[player.Name] then
                if not activeSpamWarns[player.Name] then
                    activeSpamWarns[player.Name] = true
                    spamWarningOwners[player.Name] = player.Name -- Track who initiated the spam warning
                    Chat("âš¡ You are now spam-warning all players in the server! âš¡", player)
                    spamWarnAll(player) -- Start the spam warn loop
                else
                    Chat("âš ï¸ You are already spam-warning all players! âš ï¸", player)
                end
            else
                Chat("âŒ " .. player.DisplayName .. ", you do not have permission to spam warn players. âŒ", player)
            end
        end
    elseif command == string.lower(unspamCommand) then
        if playersWithPower[player.Name] then
            -- Stop spam warnings for all players
            for spamOwner, _ in pairs(activeSpamWarns) do
                activeSpamWarns[spamOwner] = false
            end
            Chat("â›” You have stopped spam-warning all players. â›”", player)
            spamWarningOwners = {} -- Clear all spam warning owners
        else
            Chat("âŒ " .. player.DisplayName .. ", you do not have permission to stop spam warnings. âŒ", player)
        end
    elseif command == string.lower(cmdsCommand) then
        if playersWithPower[player.Name] then
            Chat("ðŸ“œ **Available commands:**\nðŸ“œ  /warns [player]\nðŸ“œ  /warns all\nðŸ“œ  /spamwarns [player]\nðŸ“œ  /spamwarns all\nðŸ“œ  /unspam\nðŸ“œ  /cmds", player)
        else
            Chat("âŒ " .. player.DisplayName .. ", you do not have permission to view the command list. âŒ", player)
        end
    end
end

Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(message)
        onPlayerChatted(player, message)
    end)
end)

for _, player in ipairs(Players:GetPlayers()) do
    player.Chatted:Connect(function(message)
        onPlayerChatted(player, message)
    end)
end
